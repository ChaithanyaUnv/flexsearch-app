import { Injectable } from '@angular/core';
import FlexSearch from 'flexsearch';

interface FileDoc {
  name: string;
content: string;
[key: string]: string;
}
@Injectable({
  providedIn: 'root'
})
export class FlexService {
  private index: any;

  private files: FileDoc[] = [
    { name: 'ohs-code.pdf', content: 'An employer must ensure that every worker can safely enter and leave a work area at all times, and that all entrances and exits are maintained in good working order and kept free from materials, equipment, waste, or other obstructions that might endanger workers or restrict movement. If a worker could be isolated from a primary escape route, the employer must provide a ready, convenient, and safe secondary means of escape that is constantly usable, and ensure that all workers are familiar with escape routes. Doors to and from work areas must open without substantial effort, remain unobstructed, be in good working order, and be equipped with a means of opening from the inside if they lead to potentially hazardous enclosed areas. Walkways, runways, and ramps must be strong enough for both equipment and workers using them, be at least 600 millimetres wide or wide enough for safe movement, and have required toe boards and guardrails. Their surfaces must provide sufficient traction for safe movement. Stairways must have uniform tread widths and riser heights, level treads, appropriate handrails on those with five or more risers, and additional safeguards such as intermediate rails on open sides; temporary stairs must be at least 600 millimetres wide. Handrails on applicable stairways must extend the full length, be securely fixed, be 800 to 920 millimetres above the tread edges, and be substantial, constructed from specified lumber dimensions or material of equivalent quality. Handrail posts must be spaced no more than 3 metres apart and meet the same material standards. An employer must ensure that workers do not use a ladder to enter or leave an elevated or sub-level work area if the area has another safe and recognizable way to enter or leave it. A person must not make a ladder by fastening cleats across a single rail or post. Subject to subsection (2), a person must not paint a wooden ladder. A wooden ladder may be preserved with a transparent protective coating. An employer must ensure that a ladder used during the servicing of energized or potentially energized electrical equipment is made of non-conductive material. If a ladder is a permanent part of an extending boom on powered mobile equipment, no worker is on the ladder during the articulation, extension or retraction of the boom, and if outriggers are incorporated in the equipment to provide stability, no worker climbs the ladder until the outriggers are deployed. Subsection (1)(a) does not apply to professional firefighters working on firefighting equipment. An employer must ensure that a crawl board or roof ladder used for roof work is securely fastened by hooking the board or ladder over the ridge of the roof or by another equally effective means, and is not supported by an eavestrough. An employer must ensure that a fixed ladder installed on or after April 30, 2004 meets the requirements of PIP Standard STF05501 (February 2002), Fixed Ladders and Cages, published by the Construction Industry Institute. Despite the standards referenced in PIP Standard STF05501, an employer may use applicable Canadian material and process standards if the employer ensures that the fixed ladder is designed and installed in accordance with established engineering principles, and may allow the inside diameter of a cage hoop to be as great as 760 millimetres. If a fixed ladder is made of a material other than steel, the employer must ensure that the design is certified by a professional engineer as being as strong as or stronger than that required by PIP Standard STF05501. The employer must ensure that a self-closing double bar safety gate, or equally effective barrier, is provided at ladderway floor openings and platforms of fixed ladders installed on or after April 30, 2004. Subsection (4) does not apply at landings. Section 327 applies to an access ladder attached to a scaffold. Despite section 130, fixed ladders used in pre-cast reinforced concrete manhole sections installed on or after July 1, 2009 must meet the requirements of ASTM Standard C478-07, Standard Specification for Reinforced Concrete Manhole Sections. If each worker working on a drilling rig or service rig on a fixed ladder is equipped with and wears a climb assist device that complies with the manufacturer’s specifications or specifications certified by a professional engineer, an employer is not required to provide the ladder with rest platforms, or have the side rails extend not less than 1050 millimetres above the point at which the workers get on or off. A worker must not perform work from either of the top 2 rungs, steps or cleats of a portable ladder unless the manufacturer’s specifications allow the worker to do so. Despite subsection (1), a worker may work from either of the top 2 rungs, steps or treads of a stepladder, if the stepladder has a railed platform at the top, or if the manufacturer’s specifications for the stepladder permit it. An employer must ensure that a constructed portable ladder is constructed of lumber that is free of loose knots or knot holes, with a length of 5 metres or less has side rails constructed of lumber measuring not less than 38 millimetres by 89 millimetres, more than 5 metres long has side rails constructed of lumber measuring not less than 38 millimetres by 140 millimetres, has side rails that are not notched, dapped, tapered or spliced, has side rails at least 500 millimetres apart at the bottom, and has rungs that are constructed of lumber measuring not less than 21 millimetres by 89 millimetres, held by filler blocks or secured by a single continuous wire, and uniformly spaced at a centre-to-centre distance of 250 millimetres to 300 millimetres. An employer must ensure that a two-way constructed portable ladder that is wide enough to permit traffic in both directions at the same time has a centre structural rail along the length of the ladder, is at least 1 metre wide, and is constructed of materials that are substantial enough in size to accommodate the maximum intended load. An employer must ensure that a portable ladder manufactured on or after July 1, 2009 meets the requirements of CSA Standard CAN3 Z11-M81 (R2005), Portable Ladders, ANSI Standard A14.1-2007, American National Standard for Ladders — Wood Safety Requirements, ANSI Standard A14.2-2007, American National Standard for Ladders — Portable Metal — Safety Requirements, or ANSI Standard A14.5-2007, American National Standard for Ladders — Portable Reinforced Plastic — Safety Requirements. A worker must ensure that a portable ladder is secured against movement and placed on a base that is stable, the base of an inclined portable ladder is no further from the base of the wall or structure than 1/4 of the distance between the base of the ladder and the place where the ladder contacts the wall, and the side rails of a portable ladder extend at least 1 metre above a platform, landing or parapet if the ladder is used as a means of access to the platform, landing or parapet. An employer must ensure that a worker working from a portable ladder from which the worker may fall 3 metres or more uses a personal fall arrest system. Subsection (1) does not apply while the worker is moving up or down the portable ladder. Despite subsection (1), if it is not reasonably practical to use a personal fall arrest system, a worker may work from a portable ladder without fall protection if the work is a light duty task of short duration at each location, the worker’s centre of balance is at the centre of the ladder at all times even with an arm extended beyond the side rails of the ladder, and the worker maintains 3-point contact whenever the worker extends an arm beyond a side rail. Rescue personnel involved in training or in providing emergency rescue services may use equipment, personal protective equipment and practices other than those specified in this Part. An employer and a supervisor must ensure that a worker is protected from falling if a worker may fall, at a temporary or permanent work area, a vertical distance of 3 metres or more, at a temporary or permanent work area, a vertical distance of less than 3 metres if there is an unusual possibility of injury, at a temporary or permanent work area, into or onto a hazardous substance or object, or through an opening in a work surface, or at a permanent work area, a vertical distance of more than 1.2 metres and less than 3 metres. For the purposes of this section, there is an unusual possibility of injury if the injury may be worse than an injury from landing on a solid, flat surface. Subject to subsection (5), an employer must install a guardrail. Subject to subsection (6), if the use of a guardrail is not reasonably practicable, an employer and a supervisor must ensure that a worker uses a travel restraint system that meets the requirements of this Part. Subject to subsection (7), if the use of a travel restraint system is not reasonably practicable, an employer and a supervisor must ensure that a worker uses a personal fall arrest system that meets the requirements of this Part. If the use of a personal fall arrest system is not reasonably practicable, an employer and a supervisor must ensure that a worker uses equally effective controls. A worker must use a fall protection system as required by this section. An employer must develop procedures that comply with this Part in a fall protection plan for a work site if a worker at the work site may fall 3 metres or more and the worker is not protected by guardrails. A fall protection plan must specify the fall hazards at the work site, the fall protection system to be used at the work site, and the anchors to be used during the work.' },
    { name: 'hazard-assessment.pdf', content: 'The hazard assessment for Work Instruction WI–ST-1200, Positioning the Substructure, details required PPE—such as PD-approved protective gloves and fall protection—and involves personnel including the crane operator, driller, derrickhand, floorhand, leasehand, motorhand, rig manager, swamper, truck driver, and truck push. Conducting a pre-use inspection is essential to prevent serious injury or fatality (SIF). Key hazards include injury if a truck driver backs over a worker inspecting lines, which is controlled by ensuring the truck/picker operator has given an “All Clear” so the truck or picker will not move during inspection. There is risk of injury or equipment damage if a load drops due to faulty or worn equipment; double lines must be identified during rig move safety meetings and truck drivers supervised to ensure compliance. During the spotting of pony subs, miscommunication and injury from being struck by or caught between loads are controlled by keeping all workers clear of suspended loads, using tag lines for maneuvering, never going under suspended loads, staying clear of trucks and loads in motion, maintaining communication with the crane operator, using proper slinging or approved pickup points on spreader bars, and staying clear as spreader bars are swung into position. When spotting the substructure off the truck, staying clear until the substructure is centered and ready to level can prevent injury or death from being struck or caught between loads, and equipment damage to lines by deck pins is avoided by not positioning between the truck and load until signaled safe. Ensuring "All Clear" during pin installation, awareness of obstructions, and careful hand placement minimize injury from pin strikes or falls. During lifting and leveling with boards, injuries from being caught under the sub are controlled by never placing hands or fingers under suspended loads but using another board for positioning, and maintaining communication via radio and voice. Raising or lowering wings on the substructure requires proper fall protection for 100% tie-off, never going under suspended loads, inspecting slings, and verifying rigging. General hazards include hand injuries from wickers, mitigated by awareness of hand placement; injury or equipment damage from not double-lining loads, controlled by verification by experienced personnel; pinch point injury during pin installation, controlled by buffer zones for workers using hammers; and miscommunication, mitigated by establishing clear communication between operators, truck push, and spotters. Additional controls include using adequate manpower to maneuver boards, lifting with legs, being aware of surroundings and hand placement when installing securement pins, and ensuring no workers are beneath work areas to prevent injury from pinch points or falling objects. Reference documentation includes the HSE Management System, Loaders, Forklifts and Manlifts, Rigging and Critical Lifting Standard, SIMOP (Rig Move Protocol), and Working at Height Standard.' },
    { name: 'work-instruction.pdf', content: 'The work instruction for ST-1500 Ideal covers the process of raising the substructure and begins with gathering required tools and equipment such as hand tools and a linear measuring device. The procedure starts with a pre-use inspection, where workers visually inspect the hydraulic tank volume, hoses, and fittings for leaks or damage, check that spring mechanisms on hydraulic fittings and ram cylinders are in good order, and ensure the substructure area has a clear, unobstructed path for movement. All employees on location are notified of the designated danger zone, which must be maintained until job completion, while all lines are checked for correct connections, oil and fuel levels are verified prior to starting the engine, and the linear measuring device is installed. Next, the hydraulic power unit engine is started, ensuring that circulating valves are open on the octopus before startup. After the engine starts, circulating valves are closed, the engine is allowed to idle and warm up for fifteen minutes, then brought to operational rpm as the pump is gradually increased to 2,500 psi (17,237 kPa). Throughout this process, engine temperature and hydraulic pressure are monitored, and the system is circulated sufficiently to remove any air by stroking each cylinder fully up and down at least twice. The substructure is then unpinned, with communication between the team and the hydraulic power unit operator to ensure hydraulics are not engaged while pins are being removed; if pins are stuck, a designated flagger directs any necessary minor adjustments. Once removed, the pins are kept ready for reinstallation after the substructure is raised. The HPU operator raises the substructure one foot out of the pockets and stops for five minutes to verify that cylinders are holding without bleeding down. All workers closely observe as the substructure is raised to ensure it lifts evenly and to watch for any snags or binding, speaking up if potential issues arise. In the event of cylinder control failure, workers follow specific steps: if hydraulic cylinders are not at the final stage, the substructure is allowed to lower evenly, potentially by pressurizing one side to maintain even loading, but the HPU is never turned off. If the cylinders are at the final stage, raising continues and the substructure is re-pinned, with the HPU remaining powered. Once raised, all operations are halted until the substructure support beams are pinned, guided into place by four employees on each walking foot support beam to prevent pad eyes from contacting each other during the final four feet of raising, under the direction of a designated flagger who signals the HPU operator as needed. The procedure concludes by shutting down the hydraulic unit, idling down the engine, bleeding off the pressure using bleed-off valves on the octopus, and operating the controls to release any remaining trapped pressure.' }
  ];

  constructor() {
    this.index = new FlexSearch.Document<FileDoc>({
        tokenize: 'forward',   // for partial/prefix matches
        encode: (text: string) => text.toLowerCase().split(/\s+/),
       // case-insensitive matching
      document: {
        id: 'name',
        index: ['name','content']
      }
    });

    for (const file of this.files) {
  this.index.add(file);
}
    console.log('Index created with files:', this.files.map(file => file.name + ': ' + file.content));
  }

  async search(query: string): Promise<FileDoc[]> {
  const results = await this.index.search(query, { enrich: true });
  console.log('FULL RAW SEARCH RESULT', results);

  // Flatten results
  const flatResults = results.flatMap((r: any) => r.result);

  // 1. If .doc is present, get .doc
  // 2. If only IDs are present, look up documents by ID
  const docs: FileDoc[] = flatResults.map((res: any) => {
    if (res && res.doc) return res.doc;   // enriched return
    if (typeof res === "string") {        // only ID returned
      return this.files.find(f => f.name === res)!;
  }
    return null;
  }).filter((doc:any): doc is FileDoc => !!doc);

  console.log('Search results for query:', query, docs);
  return docs;
}



} 
